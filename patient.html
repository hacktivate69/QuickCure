<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickCare – Patient Booking</title>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="patient.css" />
</head>
<body>
  <!-- Navbar (no Doctor/profile link / logout) -->
  <header class="navbar">
    <div class="logo">
      <img src="QuickCureLogo.jpg" alt="QuickCare Medical Logo - Stethoscope icon with blue background" onerror="this.style.display='none'" />
      <span>QuickCare</span>
    </div>
    <nav class="nav-links">
      <a href="indexPatient.html" id="homeBtn">Home</a>
      <a href="index.html" id="logoutBtn">Logout</a>
      <a href="patient_profile.html">
        <img src="User-Profile.png" alt="User  Profile"
             style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" />
      </a>
    </nav>
  </header>

  <!-- Hero -->
  <section>
    <h1 style="text-align: center; color: #2E8B57;">Your Health, Our Priority</h1>
  </section>

  <!-- Step 1: Inputs -->
  <section class="booking-flow" id="bookingStep">
    <h2>Select Your Preferences</h2>

    <label for="specialty">Medical Specialty</label>
    <select id="specialty">
      <option value="">-- Choose Specialty --</option>
      <option value="cardiology">Cardiology</option>
      <option value="dermatology">Dermatology</option>
      <option value="orthopedics">Orthopedics</option>
      <option value="pediatrics">Pediatrics</option>
      <option value="ent">ENT (Ear, Nose, Throat)</option>
      <option value="psychiatry">Psychiatry</option>
      <option value="general">General Physician</option>
      <option value="neurology">Neurology</option>
      <option value="oncology">Oncology</option>
      <option value="gynecology">Gynecology</option>
    </select>

    <label for="city">City</label>
    <select id="city">
      <option value="">-- Choose City --</option>
      <option value="delhi">Delhi</option>
      <option value="mumbai">Mumbai</option>
      <option value="bengaluru">Bengaluru</option>
      <option value="kolkata">Kolkata</option>
      <option value="chennai">Chennai</option>
      <option value="hyderabad">Hyderabad</option>
      <option value="pune">Pune</option>
      <option value="lucknow">Lucknow</option>
    </select>

    <button id="nextBtn" class="btn">Find Available Doctors</button>
  </section>

  <!-- Step 2: Ranked Hospitals -->
  <section class="hospital-list" id="hospitalSection" style="display:none;">
    <h2>Recommended Hospitals & Doctors</h2>
    <p style="text-align:center;color:#6c757d;margin-bottom:30px;">Sorted by earliest availability and best ratings</p>
    <div id="hospitalList"></div>
  </section>

  <footer>
    <p>© 2025 QuickCare. Making healthcare accessible for everyone.</p>
  </footer>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const specialtySelect = document.getElementById("specialty");
  const citySelect = document.getElementById("city");
  const nextBtn = document.getElementById("nextBtn");
  const bookingStep = document.getElementById("bookingStep");
  const hospitalSection = document.getElementById("hospitalSection");
  const hospitalListDiv = document.getElementById("hospitalList");

  const currentUser = JSON.parse(localStorage.getItem("user"));
  const token = localStorage.getItem("token");

  if (!currentUser || currentUser.role !== "patient") {
    alert("Please sign in as a patient to book an appointment.");
    window.location.href = "signin.html";
    return;
  }

  function capitalize(str) {
    return str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
  }

  function renderDoctors(doctors) {
    if (!doctors.length) {
      hospitalListDiv.innerHTML = `<p style="text-align:center;color:#6c757d;">No doctors found.</p>`;
      return;
    }

    hospitalListDiv.innerHTML = doctors.map(doc => `
      <div class="hospital-card" style="margin-bottom:25px;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:flex;align-items:center;gap:20px;">
        <img src="${doc.image || 'https://placehold.co/100x100'}" alt="${doc.name}" style="width:100px;height:100px;border-radius:50%;object-fit:cover;" />
        <div style="flex-grow:1;">
          <h3>${doc.name}</h3>
          <p>Specialty: ${capitalize(doc.specialization)}</p>
          <p>Hospital: ${doc.hospital}</p>
          <p>City: ${capitalize(doc.city)}</p>
          <p>Rating: ${doc.rating || 'N/A'} ⭐</p>
          <p>Fee: ₹${doc.fees || '—'}</p>
          <button class="btn book-btn" data-id="${doc._id}">Book Appointment</button>
        </div>
      </div>
    `).join("");

    document.querySelectorAll(".book-btn").forEach(btn => {
      btn.addEventListener("click", () => showBookingDialog(btn.getAttribute("data-id")));
    });
  }

  async function showBookingDialog(doctorId) {
    try {
      const res = await fetch(`http://localhost:3040/doctors/${doctorId}`);
      if (!res.ok) throw new Error("Doctor not found");
      const doctor = await res.json();

      let optionsHtml = "";
      (doctor.schedule || []).forEach(day => {
        (day.slots || []).forEach(slot => {
          if (!slot.booked) {
            const dateStr = day.date; // ISO string
            optionsHtml += `<option value="${dateStr}|${slot.time}">${new Date(day.date).toDateString()} - ${slot.time}</option>`;
          }
        });
      });

      if (!optionsHtml) return alert("No available slots.");

      // Modal
      const modalOverlay = document.createElement("div");
      modalOverlay.id = "bookingModalOverlay";
      modalOverlay.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.5);display:flex;
        justify-content:center;align-items:center;z-index:1000;
      `;
      const modalContent = document.createElement("div");
      modalContent.style.cssText = `
        background:#fff;padding:30px;border-radius:12px;width:320px;
        box-shadow:0 8px 25px rgba(0,0,0,0.15);text-align:center;
      `;
      modalContent.innerHTML = `
        <h3>Book with ${doctor.name}</h3>
        <p>Select an available slot:</p>
        <select id="appointmentTimeSelect" style="width:100%;padding:10px;margin-bottom:20px;">
          ${optionsHtml}
        </select>
        <button id="confirmBookingBtn" class="btn" style="width:100%;">Confirm</button>
        <button id="cancelBookingBtn" class="btn clear" style="width:100%;margin-top:10px;">Cancel</button>
      `;
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);

      // Confirm booking
      document.getElementById("confirmBookingBtn").addEventListener("click", async () => {
        const selectedSlot = document.getElementById("appointmentTimeSelect").value;
        if (!selectedSlot) return alert("Please select a slot.");

        const [dateStr, timeStr] = selectedSlot.split('|');

        try {
          const resp = await fetch("http://localhost:3040/appointments", {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
              doctorId: doctor._id,
              date: dateStr,
              time: timeStr
            })
          });

          const data = await resp.json();
          if (!resp.ok) return alert(data.msg || "Booking failed");

          alert("Appointment booked successfully!");
          document.body.removeChild(modalOverlay);
          window.location.href = "patient_profile.html";

        } catch (err) {
          console.error(err);
          alert("Booking failed due to server error.");
        }
      });

      // Cancel
      document.getElementById("cancelBookingBtn").addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
      });

    } catch (err) {
      console.error(err);
      alert("Could not load doctor details.");
    }
  }

  nextBtn.addEventListener("click", async () => {
    const specialty = specialtySelect.value;
    const city = citySelect.value;
    if (!specialty || !city) return alert("Please select both specialty and city.");

    try {
      const res = await fetch(`http://localhost:3040/doctors/search?specialty=${specialty}&city=${city}`);
      if (!res.ok) throw new Error("Search failed");
      const doctors = await res.json();

      bookingStep.style.display = "none";
      hospitalSection.style.display = "block";
      renderDoctors(doctors);
    } catch (err) {
      console.error(err);
      alert("Failed to load doctors.");
    }
  });

 const logoutBtn = document.getElementById("logoutBtn");
if (logoutBtn) {
  logoutBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("token");
    if (token) {
      try {
        await fetch("http://localhost:3040/auth/logout", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });
      } catch (err) {
        console.error("Backend logout failed:", err);
      }
    }

    // Clear frontend storage
    localStorage.removeItem("user");
    localStorage.removeItem("token");

    // Redirect to homepage
    window.location.href = "index.html";
  });
}

});
</script>

</body>
</html>